FROM python:3.13-slim

# Minimal security-focused base

# Security: Apply latest patches immediately
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y --no-install-recommends curl ca-certificates && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* && \
    groupadd -r craftx && \
    useradd -r -u 1001 -g craftx -d /app -s /bin/false craftx && \
    mkdir -p /app

# Install dependencies as root
COPY requirements.txt /tmp/
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r /tmp/requirements.txt && \
    rm -f /tmp/requirements.txt

# Install Ollama with explicit version  
ENV OLLAMA_VERSION=0.3.14
RUN curl -fsSL --proto '=https' --tlsv1.2 "https://github.com/ollama/ollama/releases/download/v${OLLAMA_VERSION}/ollama-linux-amd64" -o /usr/local/bin/ollama && \
    chmod +x /usr/local/bin/ollama

# Setup application
WORKDIR /app
COPY craftx.py start.sh ./
RUN chmod +x start.sh && \
    chown -R craftx:craftx /app

# Security: Switch to non-root user
USER craftx

# Health check with timeout
HEALTHCHECK --interval=30s --timeout=5s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

EXPOSE 8000

# Security: JSON format for signal handling
CMD ["/bin/bash", "./start.sh"]
