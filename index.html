<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline' https://global.oktacdn.com https://static.cloudflareinsights.com https://*.okta.com; style-src 'self' https://global.oktacdn.com https://cdnjs.cloudflare.com https://*.okta.com; img-src 'self' data: https: https://global.oktacdn.com https://*.okta.com https://cdn.simpleicons.org; font-src 'self' data: https://global.oktacdn.com https://*.okta.com; connect-src 'self' https://*.github.io https://*.googleapis.com https://api.github.com https://graph.microsoft.com https://appleid.apple.com https://orcid.org https://integrator-1438440.okta.com https://*.okta.com https://global.oktacdn.com; form-action 'self' https://appleid.apple.com https://accounts.google.com https://github.com https://login.microsoftonline.com https://orcid.org https://integrator-1438440.okta.com;" />
    <title>CraftX.py • Elevate your Python AI</title>
    <link rel="stylesheet" href="assets/styles.css?v=7" />
</head>

<body>
    <header class="container">
        <h1>CraftX.py</h1>
        <p class="subtitle">Python-native intelligence, modular by design.</p>
        <div id="auth-status" class="auth-status hidden"></div>
    </header>

    <section class="hero container">
        <p class="subtitle">
            A next-generation AI framework that evolves with you. Sign in to download and start building intelligent,
            ethical, and extensible Python apps today.
        </p>
        <div id="widget-container"></div>
    </section>

    <section class="container" id="about">
        <h2>Why CraftX.py?</h2>
        <p>
            Born from a passion for ethical AI and modular design, CraftX.py empowers developers to build next-level
            Python applications. We keep the core lean, plugin-driven, and fully extensible—so your code can grow as
            your ideas do.
        </p>

        <h2>About ElevateCraft</h2>
        <p>
            ElevateCraft is a community and platform dedicated to sovereignty, reproducibility, and responsible
            innovation. Our mission is to uplift developers and organizations by providing transparent, open-source
            tooling that respects privacy and fosters collaboration.
        </p>

        <h2>AI Oversight & Safety</h2>
        <p>
            Every download is vetted through an embedded AI Safety Officer powered by a proprietary model. This on-board
            guardian scans your configuration and usage patterns to prevent malicious activity, ensuring CraftX.py
            remains a force for good.
        </p>
    </section>

    <!-- Get Started (shown after successful auth) -->
    <section id="get-started" class="container hidden mt-2">
        <h2>Get started</h2>
        <p>You're signed in. Install and run CraftX.py locally:</p>
        <div class="grid">
            <div class="card card--flat">
                <strong>1) Install from PyPI</strong>
                <div class="row">
                    <code id="cmd-install" class="code-chip">pip install craftxpy</code>
                    <button class="btn" onclick="copyCmd('cmd-install')">Copy</button>
                </div>
            </div>
            <div class="card card--flat">
                <strong>2) Launch the UI</strong>
                <div class="row">
                    <code id="cmd-ui" class="code-chip">streamlit run assistant_ui/app.py</code>
                    <button class="btn" onclick="copyCmd('cmd-ui')">Copy</button>
                </div>
            </div>
            <div class="card card--flat">
                <strong>3) Run the demo</strong>
                <div class="row">
                    <code id="cmd-demo" class="code-chip">python examples/demo.py</code>
                    <button class="btn" onclick="copyCmd('cmd-demo')">Copy</button>
                </div>
            </div>
            <div class="links-row">
                <a class="btn" href="https://pypi.org/project/craftxpy/" target="_blank" rel="noopener">View on PyPI</a>
                <a class="btn" href="https://github.com/davidanderson01/CraftX.py" target="_blank"
                    rel="noopener">GitHub</a>
                <a class="btn" href="https://craftx.elevatecraft.org" target="_blank" rel="noopener">Docs</a>
            </div>
        </div>
    </section>

    <footer class="container">
        <p>&copy; 2025 ElevateCraft • MIT License • <a href="terms.html">Terms</a> • <a href="privacy.html">Privacy</a>
        </p>
    </footer>

    <script src="https://global.oktacdn.com/okta-auth-js/7.0.0/okta-auth-js.min.js"></script>

    <script>
        // IdP IDs mapping: replace values with your Okta Social IdP IDs from
        // Security > Identity Providers (e.g., "0oa..." for Google/Apple/GitHub/ORCID)
        const IDP_IDS = {
            google: '0oaupc3maq8iGRM54697', // Google IdP ID
            apple: '0oaupb8r80Z4IngVc697',  // Apple IdP ID
            github: '0oaupa0r6r0HlruYA697', // GitHub IdP ID
            orcid: '0oaupctyr9JeYfadv697'   // ORCID IdP ID
        };

        // 1. Okta Auth SDK Configuration
        // Compute redirect URI from the current page so it works on both
        // craftx.elevatecraft.org and GitHub Pages (repo path).
        (function () {
            // Normalize origin for local dev: Okta only allows http for 'localhost' (not 127.0.0.1/0.0.0.0)
            const loc = window.location;
            let origin = loc.origin;
            try {
                const u = new URL(origin);
                const isLocalHttp = u.protocol === 'http:' && (u.hostname === '127.0.0.1' || u.hostname === '0.0.0.0');
                if (isLocalHttp) {
                    const port = u.port ? (":" + u.port) : '';
                    origin = `${u.protocol}//localhost${port}`;
                    console.warn('Redirect URI normalized for Okta local dev:', origin);
                }
            } catch (e) { /* noop */ }
            // e.g., / or /CraftX.py/
            let path = loc.pathname;
            // Normalize to the base path (end with '/') so the redirect matches an app URI exactly
            if (!path.endsWith('/')) {
                path = path.substring(0, path.lastIndexOf('/') + 1);
            }
            const dynamicRedirectUri = origin + path; // e.g., https://craftx.elevatecraft.org/ or https://davidanderson01.github.io/CraftX.py/

            window.oktaAuth = new OktaAuth({
                issuer: 'https://integrator-1438440.okta.com/oauth2/default',
                clientId: '0oauoqj5bfJFAoN3x697',
                redirectUri: dynamicRedirectUri,
                scopes: ['openid', 'profile', 'email'],
                pkce: true
            });

            console.log('Using redirectUri:', dynamicRedirectUri);
        })();

        // 2. Handle the callback after redirect FIRST, then check auth
        (async function initAuthFlow() {
            try {
                if (oktaAuth.isLoginRedirect()) {
                    try {
                        await oktaAuth.handleLoginRedirect();
                    } catch (err) {
                        console.error('Login redirect error:', err);
                        alert('Login redirect error: ' + (err.errorSummary || err.message || err.toString()));
                        showLoginForm();
                        return;
                    }
                }

                const isAuthenticated = await oktaAuth.isAuthenticated();
                if (!isAuthenticated) {
                    showLoginForm();
                    return;
                }

                // Try to fetch user via userinfo; fall back to ID token claims if CORS blocks it
                try {
                    const user = await oktaAuth.getUser();
                    const display = resolveDisplayName(user);
                    showAuthSuccess(display);
                } catch (userErr) {
                    console.warn('getUser failed (likely CORS). Falling back to ID token claims:', userErr);
                    try {
                        const idToken = await oktaAuth.tokenManager.get('idToken');
                        const claims = idToken && idToken.claims ? idToken.claims : {};
                        const display = resolveDisplayName(claims);
                        showAuthSuccess(display);
                    } catch (claimErr) {
                        console.error('Failed to get ID token claims:', claimErr);
                        showLoginForm();
                    }
                }
            } catch (e) {
                console.error('Auth init flow error:', e);
                showLoginForm();
            }
        })();

        // 4. Show login form
        function showLoginForm() {
            const container = document.getElementById('widget-container');
            container.innerHTML = `
                <div class="card">
                    <h3>Sign in to CraftX.py</h3>
                    <form id="login-form" class="form-column">
                        <input type="email" id="username" placeholder="Email" required class="input">
                        <input type="password" id="password" placeholder="Password" required class="input">
                        <button type="submit" class="btn-primary">Sign In</button>
                    </form>
                    <div class="center mt-1">
                        <button id="oauth-login" class="btn-success">Sign in with Okta</button>
                    </div>
                    <div class="divider"><span>or</span></div>
                    <div class="signin-grid">
                        <button id="oauth-google" class="btn-oauth btn-google">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" aria-hidden="true" focusable="false">
                                <path fill="#EA4335" d="M17.64 9.2045c0-.638-.0573-1.2518-.1636-1.8409H9v3.4818h4.8445c-.2091 1.125-.8455 2.0795-1.8 2.7205v2.2568h2.9086c1.7018-1.5677 2.687-3.8741 2.687-6.6182z"/>
                                <path fill="#34A853" d="M9 18c2.43 0 4.47-.8 5.96-2.19l-2.74-2.12c-.76.51-1.74.81-3.22.81-2.47 0-4.57-1.67-5.32-3.93H.94v2.475C2.43 15.98 5.86 18 9 18z"/>
                                <path fill="#FBBC05" d="M3.68 10.57c-.18-.56-.28-1.16-.28-1.77s.1-1.21.28-1.77V4.56H.94C.34 5.77 0 6.86 0 8s.34 2.23.94 3.44l2.74-2.87z"/>
                                <path fill="#4285F4" d="M9 3.48c1.32 0 2.5.45 3.43 1.33l2.57-2.57C13.46.86 11.46 0 9 0 5.86 0 2.43 2.02.94 4.56l2.74 2.47C4.43 5.15 6.53 3.48 9 3.48z"/>
                            </svg>
                            Continue with Google
                        </button>
                        <button id="oauth-apple" class="btn-oauth btn-apple">
                            <img class="icon" src="https://cdn.simpleicons.org/apple/FFFFFF" alt="Apple" />
                            Continue with Apple
                        </button>
                        <button id="oauth-github" class="btn-oauth btn-github">
                            <img class="icon" src="https://cdn.simpleicons.org/github/FFFFFF" alt="GitHub" />
                            Continue with GitHub
                        </button>
                        <button id="oauth-orcid" class="btn-oauth btn-orcid">
                            <img class="icon" src="https://cdn.simpleicons.org/orcid/FFFFFF" alt="ORCID" />
                            Continue with ORCID
                        </button>
                    </div>
                    <div class="center mt-1">
                        <button id="test-config" class="btn">Test Okta Config</button>
                    </div>
                    <div id="dev-tools" class="center mt-1 hidden">
                        <p class="auth-status">Dev tools (localhost only)</p>
                        <div class="row">
                            <button id="copy-logout-uri" class="btn">Copy Logout Redirect URI</button>
                        </div>
                        <div class="signin-grid mt-1">
                            <button id="copy-authorize-google" class="btn">Copy Google Authorize URL</button>
                            <button id="copy-authorize-apple" class="btn">Copy Apple Authorize URL</button>
                            <button id="copy-authorize-github" class="btn">Copy GitHub Authorize URL</button>
                            <button id="copy-authorize-orcid" class="btn">Copy ORCID Authorize URL</button>
                        </div>
                    </div>
                </div>
            `;

            // Handle form submission
            document.getElementById('login-form').addEventListener('submit', function (e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                oktaAuth.signInWithCredentials({
                    username: username,
                    password: password
                }).then(function (transaction) {
                    if (transaction.status === 'SUCCESS') {
                        oktaAuth.getUser().then(function (user) {
                            showAuthSuccess(user.name || user.preferred_username || user.email);
                        });
                    }
                }).catch(function (err) {
                    console.error('Login error:', err);
                    alert('Login failed: ' + (err.errorSummary || err.message));
                });
            });

            // Handle OAuth login
            document.getElementById('oauth-login').addEventListener('click', function () {
                try {
                    console.log('OAuth login clicked - clearing tokens & transactions');
                    try { oktaAuth.tokenManager.clear(); } catch (e) { console.log('tokenManager.clear err', e); }
                    try { oktaAuth.transactionManager.clear(); } catch (e) { console.log('transactionManager.clear err', e); }

                    console.log('Starting OAuth redirect with explicit authorization params...');
                    oktaAuth.token.getWithRedirect({
                        responseType: 'code',
                        scopes: ['openid', 'profile', 'email'],
                        prompt: 'login'
                    }).catch(function (err) {
                        console.error('getWithRedirect failed:', err);
                        alert('OAuth redirect failed: ' + (err.errorSummary || err.message || err.toString()));
                    });
                } catch (err) {
                    console.error('OAuth click error:', err);
                    alert('OAuth error: ' + err.message);
                }
            });

            // Social IdP buttons
            const idpButtons = [
                { id: 'oauth-google', key: 'google' },
                { id: 'oauth-apple', key: 'apple' },
                { id: 'oauth-github', key: 'github' },
                { id: 'oauth-orcid', key: 'orcid' },
            ];
            idpButtons.forEach(({ id, key }) => {
                const btn = document.getElementById(id);
                if (!btn) return;
                btn.addEventListener('click', () => loginWithIdp(key));
                if (!IDP_IDS[key]) {
                    btn.classList.add('disabled');
                    btn.title = 'Configure ' + key + ' IdP ID in code to enable';
                }
            });

            // Handle test config button (no network): prepare PKCE params and log authorization URL
            document.getElementById('test-config').addEventListener('click', async function () {
                try {
                    const cfg = oktaAuth.options;
                    console.log('Okta Configuration:', {
                        issuer: cfg.issuer,
                        clientId: cfg.clientId,
                        redirectUri: cfg.redirectUri,
                        scopes: cfg.scopes
                    });

                    // Prepare token params locally (generates PKCE verifier/challenge)
                    const params = await oktaAuth.token.prepareTokenParams({
                        responseType: 'code',
                        scopes: cfg.scopes
                    });
                    console.log('Prepared token params:', params);

                    // Construct an authorize URL for visual verification
                    const url = new URL(cfg.issuer.replace(/\/$/, '') + '/v1/authorize');
                    url.searchParams.set('client_id', cfg.clientId);
                    url.searchParams.set('response_type', 'code');
                    url.searchParams.set('scope', cfg.scopes.join(' '));
                    url.searchParams.set('redirect_uri', cfg.redirectUri);
                    url.searchParams.set('state', params.state);
                    url.searchParams.set('code_challenge_method', 'S256');
                    url.searchParams.set('code_challenge', params.codeChallenge);

                    const authUrl = url.toString();
                    console.log('Computed authorize URL:', authUrl);
                    try {
                        await navigator.clipboard.writeText(authUrl);
                        console.log('Authorize URL copied to clipboard');
                    } catch (e) {
                        console.warn('Failed to copy authorize URL to clipboard:', e);
                    }
                    const u = new URL(cfg.redirectUri);
                    const needsLocalhost = (u.protocol === 'http:' && (u.hostname === '127.0.0.1' || u.hostname === '0.0.0.0'));
                    const localNote = needsLocalhost
                        ? '\n\nNote: Okta only allows http for localhost. Use http://localhost:' + (u.port || '8000') + '/ and add it to your Okta SPA app Redirect URIs.'
                        : '';
                    alert('✅ Local config looks good.\n\nIssuer: ' + cfg.issuer + '\nRedirect URI: ' + cfg.redirectUri + '\n\nComputed authorize URL (copied to clipboard):\n' + authUrl + '\n\nIf a 400 persists, make sure this exact redirect_uri is whitelisted in your Okta SPA app.' + localNote);
                } catch (err) {
                    console.error('Test config error:', err);
                    alert('❌ Test config error: ' + (err.message || err.toString()));
                }
            });

            // Dev-only helpers
            try {
                if (location.hostname === 'localhost') {
                    const dev = document.getElementById('dev-tools');
                    if (dev) dev.classList.remove('hidden');
                    const copyLogout = document.getElementById('copy-logout-uri');
                    copyLogout?.addEventListener('click', function () {
                        try { navigator.clipboard.writeText(oktaAuth.options.redirectUri); alert('Copied: ' + oktaAuth.options.redirectUri); } catch (_) { }
                    });
                    const addCopyHandler = (btnId, idpKey) => {
                        const btn = document.getElementById(btnId);
                        btn?.addEventListener('click', async function () {
                            try {
                                const cfg = oktaAuth.options;
                                const params = await oktaAuth.token.prepareTokenParams({ responseType: 'code', scopes: cfg.scopes });
                                const url = new URL(cfg.issuer.replace(/\/$/, '') + '/v1/authorize');
                                url.searchParams.set('client_id', cfg.clientId);
                                url.searchParams.set('response_type', 'code');
                                url.searchParams.set('scope', cfg.scopes.join(' '));
                                url.searchParams.set('redirect_uri', cfg.redirectUri);
                                url.searchParams.set('state', params.state);
                                url.searchParams.set('code_challenge_method', 'S256');
                                url.searchParams.set('code_challenge', params.codeChallenge);
                                url.searchParams.set('prompt', 'login');
                                const idp = IDP_IDS[idpKey];
                                if (idp) url.searchParams.set('idp', idp);
                                const authUrl = url.toString();
                                await navigator.clipboard.writeText(authUrl);
                                alert('Authorize URL copied to clipboard:\n' + authUrl);
                            } catch (e) {
                                alert('Failed to build/copy URL: ' + (e.message || e.toString()));
                            }
                        });
                    };
                    addCopyHandler('copy-authorize-google', 'google');
                    addCopyHandler('copy-authorize-apple', 'apple');
                    addCopyHandler('copy-authorize-github', 'github');
                    addCopyHandler('copy-authorize-orcid', 'orcid');
                }
            } catch (_) { }
        }

        // 5. Display success message
        function showAuthSuccess(userIdentifier) {
            document.getElementById('widget-container').style.display = 'none';
            // Reveal the Get Started panel and scroll to it
            try {
                const gs = document.getElementById('get-started');
                if (gs) gs.classList.remove('hidden');
            } catch (e) { console.warn('Could not reveal get-started section:', e); }
            updateAuthStatus(userIdentifier);
            const modal = document.createElement('div');
            modal.className = 'auth-modal';
            modal.innerHTML = `
                <div class="auth-modal-content">
                    <h3>🎉 Authentication Successful!</h3>
                    <p><strong>Welcome:</strong> ${userIdentifier}</p>
                    <p>You can now download CraftX.py!</p>
                    <button onclick="document.getElementById('get-started')?.scrollIntoView({behavior:'smooth'}); this.parentElement.parentElement.remove()" class="btn">Continue</button>
                    <button onclick="logout()" class="btn btn-danger ml-05">Logout</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 6. Logout function
        async function logout() {
            try {
                // Optional UI reset before redirect (do not clear tokens yet; needed for id_token_hint)
                try { document.getElementById('auth-status')?.classList.add('hidden'); } catch (e) { }
                try { const wc = document.getElementById('widget-container'); if (wc) wc.style.display = ''; } catch (e) { }
                try { document.querySelector('.auth-modal')?.remove(); } catch (e) { }

                const postLogoutRedirectUri = (oktaAuth && oktaAuth.options && oktaAuth.options.redirectUri)
                    ? oktaAuth.options.redirectUri
                    : (function () {
                        const origin = window.location.origin;
                        let path = window.location.pathname;
                        if (!path.endsWith('/')) {
                            path = path.substring(0, path.lastIndexOf('/') + 1);
                        }
                        return origin + path;
                    })();

                // Fetch id_token first so we can safely clear tokens pre-redirect if needed
                let idTokenStr = undefined;
                try {
                    const idt = await oktaAuth.tokenManager.get('idToken');
                    idTokenStr = idt && idt.idToken;
                } catch (_) { }

                // Request Okta logout with redirect back; include id_token to ensure session termination
                oktaAuth.signOut({ postLogoutRedirectUri, idToken: idTokenStr, clearTokensBeforeRedirect: true }).catch((err) => {
                    const msg = (err && (err.errorSummary || err.message || String(err))) || '';
                    if (String(msg).includes('post_logout_redirect_uri')) {
                        alert('Logout redirect not allowed by Okta. Add this URL to your Okta app\'s "Logout redirect URIs":\n\n' + postLogoutRedirectUri + '\n\nOkta Admin → Applications → Your SPA → General → Logout redirect URIs.');
                    }
                    // Fallback: clear local state and navigate
                    try { oktaAuth.tokenManager.clear(); } catch (e) { }
                    try { oktaAuth.transactionManager.clear(); } catch (e) { }
                    try { localStorage.removeItem('okta-token-storage'); } catch (e) { }
                    // Try a non-redirect logout (may land on Okta page), then go back
                    try { oktaAuth.signOut().catch(() => { }); } catch (e) { }
                    setTimeout(() => { window.location.href = postLogoutRedirectUri; }, 300);
                });
            } catch (e) {
                window.location.reload();
            }
        }

        // 6b. Dev-only local logout (does not end Okta SSO, just clears local state)
        function localLogout() {
            try { oktaAuth.tokenManager.clear(); } catch (e) { }
            try { oktaAuth.transactionManager.clear(); } catch (e) { }
            try { localStorage.removeItem('okta-token-storage'); } catch (e) { }
            try {
                // Clear common Okta PKCE temp storage keys
                Object.keys(sessionStorage).forEach(k => { if (k.startsWith('okta-')) sessionStorage.removeItem(k); });
            } catch (e) { }
            // Navigate back to app base
            const origin = window.location.origin;
            let path = window.location.pathname;
            if (!path.endsWith('/')) {
                path = path.substring(0, path.lastIndexOf('/') + 1);
            }
            window.location.href = origin + path;
        }

        // 7. Update header auth status and show a persistent logout
        function updateAuthStatus(display) {
            const el = document.getElementById('auth-status');
            if (!el) return;
            el.classList.remove('hidden');
            const isLocal = window.location.hostname === 'localhost';
            const extra = isLocal ? ` · <a class="logout" href="#" onclick="localLogout(); return false;">Local logout</a>` : '';
            el.innerHTML = `Signed in as <strong>${display}</strong> · <a class="logout" href="#" onclick="logout(); return false;">Logout</a>${extra}`;
        }

        // Copy helper for Get Started commands
        function copyCmd(id) {
            try {
                const el = document.getElementById(id);
                if (!el) return;
                const text = el.textContent;
                navigator.clipboard.writeText(text).then(() => {
                    console.log('Copied:', text);
                }).catch(err => {
                    console.warn('Clipboard failed:', err);
                });
            } catch (e) {
                console.warn('copyCmd error:', e);
            }
        }

        // Prefer alias for display (nickname/preferred_username/displayName/alias > email > name)
        function resolveDisplayName(source) {
            if (!source) return 'Signed in';
            return (
                source.nickname ||
                source.preferred_username ||
                source.displayName ||
                source.alias ||
                source.email ||
                source.name ||
                'Signed in'
            );
        }

        // Kick off a redirect to a specific IdP
        function loginWithIdp(key) {
            const idp = IDP_IDS[key];
            if (!idp) {
                alert('Set the ' + key + ' IdP ID in IDP_IDS at the top of the script.');
                return;
            }
            try { oktaAuth.tokenManager.clear(); } catch (e) { }
            try { oktaAuth.transactionManager.clear(); } catch (e) { }
            oktaAuth.token.getWithRedirect({
                responseType: 'code',
                scopes: ['openid', 'profile', 'email'],
                prompt: 'login',
                authorizationParams: { idp }
            }).catch(function (err) {
                console.error('IdP redirect failed:', err);
                alert('IdP redirect failed: ' + (err.errorSummary || err.message || err.toString()));
            });
        }
    </script>
</body>

</html>